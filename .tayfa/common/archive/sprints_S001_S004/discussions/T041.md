# Task discussion T041: Перемешанный старт + картинка-цель в углу

## [2026-02-26 16:03] boss (author)

### Task description

ФУНДАМЕНТАЛЬНОЕ ИЗМЕНЕНИЕ ГЕЙМПЛЕЯ — идея владельца продукта.

## Текущее поведение (ПЛОХО)
- Уровень начинается из ПРАВИЛЬНОГО расположения (identity: [A B C D E F])
- Тождество находится бесплатно кнопкой ПРОВЕРИТЬ
- Игрок не понимает что делать: 'уже всё правильно, зачем менять?'

## Новое поведение (ХОРОШО)
- Уровень начинается из ПЕРЕМЕШАННОГО расположения
- В левом верхнем углу показана ЦЕЛЬ: миниатюра графа в правильном виде (цвета + рёбра, БЕЗ БУКВ)
- Игрок должен СОБРАТЬ как на картинке → это и есть identity (первый ключ!)
- Потом обнаруживает: есть ДРУГИЕ правильные расположения → симметрии!

## Почему это лучше
1. Понятная начальная цель — 'собери как на картинке' (знакомо из пазлов)
2. Identity больше не бесплатный — игрок реально РАБОТАЕТ чтобы его найти
3. Момент открытия — 'а есть ДРУГОЕ правильное расположение?!' = суть симметрии
4. Картинка без букв учит: важна СТРУКТУРА, не подписи

## Реализация

### 1. Перемешивание стартовой позиции
В level_scene.gd после создания кристаллов:
- Сгенерировать случайную перестановку (Fisher-Yates shuffle)
- НЕ identity — проверить что shuffle != [0,1,2,...,n-1]
- Применить к позициям кристаллов: кристалл i ставится на позицию shuffle[i]
- current_arrangement = shuffle (а не identity)
- Сохранять seed в save_data чтобы перемешивание было одинаковым при перезагрузке

### 2. Миниатюра-цель (Target Preview)
В левом верхнем углу (примерно 150x150 px):
- Полупрозрачная панель с миниатюрой графа
- Показывает ПРАВИЛЬНОЕ расположение: узлы с цветами + рёбра (стрелки если directed)
- БЕЗ БУКВ / labels — только структура!
- Масштаб: граф уменьшен чтобы поместиться в 150x150
- Рамка: тонкая золотая при невыполненном identity, зелёная после нахождения identity
- Тултип: 'Цель: расположите кристаллы как показано'

Реализация миниатюры:
- Создать SubViewport (150x150) + SubViewportContainer
- Или проще: рисовать через _draw() на CanvasLayer — кружки цветов + линии рёбер
- Вариант 2 проще и легче

### 3. Модификация валидации
Текущая логика: perm = current_arrangement, проверяем perm в target_perms
Это НЕ МЕНЯЕТСЯ — валидация работает так же, просто starting perm != identity

### 4. Модификация уровней JSON (НЕ НУЖНА)
Перемешивание — runtime, данные уровней не меняются.

### 5. Кнопка СБРОС
Сейчас СБРОС возвращает к identity. С перемешиванием:
- СБРОС возвращает к ПЕРЕМЕШАННОМУ состоянию (стартовому)
- Это логично: 'начать заново' = вернуться к началу, а не к ответу

### 6. Agent Bridge
- Команда get_state() должна возвращать начальную перестановку (shuffle)
- Новый флаг в состоянии: is_shuffled: true, target_arrangement: [0,1,2,...,n-1]

## Критерии приёмки
1. [ ] Кристаллы начинаются в перемешанном порядке
2. [ ] Перемешивание != identity (всегда что-то перемещено)
3. [ ] Миниатюра-цель в левом верхнем углу показывает правильный граф без букв
4. [ ] Identity находится когда игрок СОБИРАЕТ правильный порядок
5. [ ] СБРОС возвращает к перемешанному состоянию (не к identity)
6. [ ] Все 12 уровней работают с перемешиванием
7. [ ] Agent Bridge корректно работает с перемешанным стартом
8. [ ] Повторная загрузка уровня даёт то же перемешивание (seed)

MUST прочитать: src/game/level_scene.gd (строки 570-650 — создание кристаллов)

### Acceptance criteria

[To be clarified]

---
