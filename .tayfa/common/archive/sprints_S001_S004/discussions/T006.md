# Task discussion T006: Integrate Engine + UI into Playable Levels 1-3

## [2026-02-21 00:01] boss (author)

### Task description

Integrate developer_game's permutation engine with developer_ui's visual layer. Result: a running desktop application where player can see 3 crystals in triangle, drag them to swap positions, get visual feedback on symmetry preservation, collect valid permutations in key ring, and complete level when all 3 rotations of Z3 are found. Must launch and be playable.

### Acceptance criteria

[To be clarified]

---

## [2026-02-21 11:00] developer_game (executor)

### What was done

Integrated the core permutation engine (T004) with the visual layer (T005) in `level_scene.gd`. The LevelScene now uses `Permutation`, `CrystalGraph`, and `KeyRing` classes from the core engine instead of raw arrays and dictionaries.

### Changes made

**Modified:** `src/game/level_scene.gd` — Core integration (8 targeted edits):
1. Replaced `found_symmetries: Array[Dictionary]` with `KeyRing` instance
2. Added `CrystalGraph` built from level JSON graph data
3. Added `target_perms: Dictionary` mapping sym_id → `Permutation` objects
4. `_build_level()` now initializes core engine objects alongside visuals
5. `_perform_swap()` creates `Permutation` objects instead of raw arrays
6. `_validate_permutation()` now takes `Permutation`, uses `KeyRing.add_key()` with duplicate detection, and checks `KeyRing.is_complete()` for win condition
7. `_update_counter()` and `_update_keyring_display()` read from `KeyRing`
8. Public API: `get_key_ring()`, `get_crystal_graph()`, `get_current_permutation()` return core engine types

**Created:** `tests/fast/unit/test_integration.py` — 20 integration tests

### Integration architecture

```
Level JSON → CrystalGraph (engine) + target_perms (Permutation objects)
                                    ↓
Player swap → Permutation.from_array(current_arrangement)
                                    ↓
_validate_permutation(perm) → match against target_perms
                                    ↓
KeyRing.add_key(perm) → duplicate detection, is_complete() check
                                    ↓
FeedbackFX → valid/invalid/complete visual feedback
```

### Test results: 57/57 PASSED (37 core + 20 integration)

### Known issue: Level 2 JSON data discrepancy

Level 2 (`level_02.json`) claims Z3 (3 rotations) as valid automorphisms, but the graph has a THICK edge that breaks rotational symmetry. The core engine correctly computes only Z2 for this graph. The JSON targets include rotations that the engine would reject. This was documented in T004. Game validation uses JSON targets (not engine), so the level is still playable as designed, but the math is inconsistent.

### Note on launchability

The task requires "Must launch and be playable." Godot 4.3+ is not installed on this machine, so I cannot physically launch the application. The integration is code-complete and verified via 57 passing tests. To launch: install Godot 4.3+, open `TheSymmetryVaults/project.godot`, and run.

---
