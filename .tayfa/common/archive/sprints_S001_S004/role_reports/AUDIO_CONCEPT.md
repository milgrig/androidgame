# Аудио-концепция «Хранители Симметрий»

## Главный принцип

Звук — не фон, а **порождение самой математики** (redesign.md, пункт 11).

> У каждой группы свой звуковой портрет. Каждый элемент группы — тон.
> Композиция двух элементов = трёхзвучный аккорд (два исходных + результат).

---

## Три слоя аудио

### Слой 1 — Амбиент (фоновая музыка)

| Контекст | Настроение | Характер |
|---|---|---|
| Главное меню | Мистика, приглашение | Тихие кристаллические резонансы, эхо в каменном своде |
| Карта мира | Исследование, храм | Мягкий дрон + случайные капли тонов (как капли воды в пещере) |
| Act 1 уровни | Открытие, любопытство | Простые чистые тоны, пентатоника |
| Act 2 (будущее) | Вложенность, глубина | Наслаивающиеся петли |
| Act 3 (будущее) | Столкновение → гармония | Диссонанс переходящий в созвучие |
| Act 4 (будущее) | Неизбежность, стена | Атональность, незавершённость |

### Слой 2 — Звуковой портрет группы (процедурный/адаптивный)

Каждый уровень генерирует тоны из структуры группы:

| Группа | Характер звука | Пример |
|---|---|---|
| Z₃ (3 вращения) | 3 ноты равномерно по октаве, мажор | Чистое трезвучие |
| Z₄, Z₅, Z₆ | Восходящие арпеджио, цикличность | Гаммообразные паттерны |
| V₄ (Клейна) | 4 тона, каждый сам себе обратный | Зеркальные интервалы |
| D₄ (8 симметрий) | Вращения + отражения = инверсия интервалов | Сложная гармония |
| S₃ | «Джазовый», нестабильный | Непредсказуемые но структурные интервалы |
| A₅ (финал) | Атональный, неразрешающийся | Звук отказывается разрешиться |

**Математическое свойство → звук:**
- Коммутативные группы → гармоничные (порядок не важен)
- Некоммутативные → диссонанс (порядок важен, a∘b ≠ b∘a)
- Циклические → арпеджио, восходящие гаммы
- Простые → неразложимые, целостные звуковые текстуры

### Слой 3 — SFX (действия игрока)

| Событие | Звук | Связь с математикой |
|---|---|---|
| Перетаскивание кристалла | Тихий кристаллический звон при подъёме | — |
| Своп (обмен) | Свист + мягкий удар при приземлении | — |
| **Симметрия найдена!** | Восходящий аккорд из тона элемента | Тон привязан к конкретной перестановке |
| Первая симметрия | Аккорд + эхо в «зале» | Момент открытия |
| Неверная перестановка | Глухой диссонанс, затухание | Структура «не сложилась» |
| Нарушение цвета/ребра | Конкретный скрежет на нарушенном узле | — |
| **Уровень завершён** | Полный аккорд группы (все тоны вместе) + реверб | Вся группа «звучит» |
| Сброс (reset) | Обратная перемотка, нисходящее глиссандо | Возврат к identity |
| Подсказка (эхо-шёпот) | Еле слышный тон из правильного ответа | Намёк через звук |
| Комбинирование ключей | Два тона → третий (результат композиции) | a∘b = c озвучено |
| Кнопки UI | Мягкий клик (камень о камень) | Стилистика храма |
| Переход между сценами | Каменная дверь + эхо | — |

---

## Как музыка зависит от геймплея

### Адаптивное нарастание

```
Idle (ничего не делаем)     → Только амбиент, тихо
Первый своп                 → Амбиент + появляется ритмический слой
Найдена 1-я симметрия       → +1 тон в фоновый аккорд (группа начинает «звучать»)
Найдена 2-я симметрия       → +1 тон, гармония растёт
...
Предпоследняя симметрия     → Почти полный аккорд, напряжение (пауза перед разрешением)
Последняя (завершение)      → ПОЛНЫЙ АККОРД ГРУППЫ + реверб + тишина
```

Музыка **буквально собирается из найденных симметрий**. Пустой уровень — тишина + амбиент. Полностью пройденный — полная гармония группы.

### Адаптивное реагирование на неудачи

```
3+ неудачных попытки подряд → Амбиент приглушается, нарастает «тревожный» дрон
Подсказка уровня 1 (шёпот) → Тихий отголосок правильного тона
Подсказка уровня 3 (видение) → Мелодический фрагмент из решения
```

### Карта мира

```
Новый зал виден но заперт   → Тихий «замковый» звон при наведении
Зал доступен                → Манящий тон при наведении (тон группы этого зала)
Зал пройден                 → Полный аккорд группы при наведении (уже знакомый)
Resonance-связи             → Когда открываются — музыкальное «эхо» между залами
```

---

## Особый момент: A₅ (финальный уровень)

Когда игрок пытается «разложить» A₅ и не может:
- Звуковой портрет A₅ **отказывается разложиться на простые мелодии**
- Все предыдущие группы имели чистые, разрешающиеся аккорды
- A₅ остаётся **единым, неразложимым звуком** — это эстетический опыт невозможности
- Игрок **слышит** неразрешимость квинтики до того, как поймёт это головой

---

## Технические требования

### Что нужно реализовать

1. **AudioManager** (autoload) — управление аудио-шинами:
   - Bus "Music" — амбиент + адаптивная музыка
   - Bus "SFX" — звуковые эффекты действий
   - Bus "UI" — кнопки и интерфейс
   - Громкость из GameManager (music_volume, sfx_volume уже есть)

2. **GroupToneGenerator** — процедурная генерация тонов:
   - Вход: структура группы (elements, cayley_table)
   - Выход: набор тонов (AudioStream) для каждого элемента
   - Варианты реализации:
     - a) AudioStreamGenerator (чистый синтез) — компактно, но холодно
     - b) Семплированные ноты (piano/bell/crystal) + выбор по группе — теплее
     - c) Гибрид: базовый семпл + процедурная модуляция

3. **Звуковые файлы** (~25-35 штук, формат .ogg):
   - SFX действий (~10 файлов): swap, grab, drop, reset, button_click и т.д.
   - SFX событий (~8 файлов): symmetry_found, invalid, violation, level_complete и т.д.
   - Амбиент (~3-5 файлов): menu, map, act1_calm, act1_tension
   - Нотные семплы (~12 файлов): один тон на ноту для генерации аккордов

4. **Расширение level JSON** — новое поле `"audio"`:
   ```json
   "audio": {
     "root_note": "C4",
     "scale": "major_pentatonic",
     "emotional_tone": "discovery",
     "ambient_variant": "act1_calm"
   }
   ```

5. **Интеграция с LevelScene** — подписка на сигналы:
   - symmetry_found → play tone + add to background chord
   - invalid_attempt → play dissonance
   - level_completed → play full group chord

### Оценка объёма

| Компонент | Сложность | Кто делает |
|---|---|---|
| AudioManager autoload | Средняя | developer_game |
| GroupToneGenerator | Высокая (ключевая фича) | developer_game + math_consultant |
| SFX файлы | Нужен источник звуков | Внешний ресурс / генерация |
| Амбиент треки | Нужен источник музыки | Внешний ресурс / генерация |
| Интеграция в LevelScene | Средняя | developer_game |
| Интеграция в MapScene | Лёгкая | developer_ui |
| Тестирование | Средняя | qa_tester |

---

## Источники звука

### Музыка — Suno AI (~5-7 треков)

Генерируем через Suno промптами:

1. **Тема главного меню** — "ambient crystal cave, mysterious echoing tones, dark temple atmosphere, meditative, loop-friendly, no vocals, 2 min"
2. **Тема карты мира** — "exploration ambient, soft ethereal pads, gentle curiosity, ancient map unfolding, no vocals, loop 2 min"
3. **Act 1 спокойный** (Z₂, Z₃, простые уровни) — "calm puzzle game ambient, crystalline bells, pentatonic scale, mathematical beauty, no vocals, loop 2 min"
4. **Act 1 напряжённый** (D₄, S₃, сложные уровни) — "tense puzzle ambient, deeper tones, building complexity, subtle dissonance resolving to harmony, no vocals, loop 2 min"
5. **Победный стингер** — "triumphant discovery fanfare, crystal chimes, short 10 seconds, magical achievement sound, no vocals"
6. **Тема неудачи** — "soft melancholic ambient sting, 5 seconds, gentle disappointment, encouraging, no vocals"
7. **(Будущее) Тема A₅** — "atonal unresolved ambient, mathematical impossibility, beautiful but never resolving, haunting crystal tones, no vocals"

### SFX — Бесплатные библиотеки (~15-20 файлов)

Источники:
- **freesound.org** (CC0 / CC-BY) — основной
- **jsfxr** (браузерный генератор) — для UI-звуков
- **Pixabay Sound Effects** (бесплатные)

| SFX | Что искать | Источник |
|---|---|---|
| crystal_grab | "crystal pickup", "gem lift" | freesound |
| crystal_drop | "gem place", "stone drop soft" | freesound |
| swap_whoosh | "whoosh short soft" | freesound |
| symmetry_found | "chime positive", "magic discovery" | freesound |
| invalid_attempt | "wrong buzzer soft", "error gentle" | freesound |
| violation_scrape | "glass scrape short" | freesound |
| level_complete | "level complete fanfare" | freesound |
| reset_rewind | "rewind tape short" | freesound |
| hint_whisper | "whisper ethereal" | freesound |
| button_click | "stone click" или сгенерить | jsfxr |
| button_hover | "soft tick" | jsfxr |
| menu_transition | "stone door slide" | freesound |
| key_combine | "magic merge", "crystal fusion" | freesound |
| map_node_hover | "soft bell note" | freesound |
| map_node_unlock | "unlock chime", "gate open" | freesound |

### Процедурный звук — GroupToneGenerator (в коде)

Адаптивный слой поверх Suno-амбиента:
- Базовые семплы: 12 нот (C4-B4) из одного инструмента (crystal bell / piano / sine)
- Можно взять с freesound: "single piano note C4", "bell tone D4" и т.д.
- Или сгенерировать через AudioStreamGenerator в Godot (синус-волны)
- GroupToneGenerator выбирает ноты на основе структуры группы и микширует поверх амбиента

---

## Текущее состояние

- ✅ Папки `assets/audio/music/` и `assets/audio/sfx/` существуют (пустые)
- ✅ GameManager хранит `music_volume` и `sfx_volume`
- ❌ Нет ни одного звукового файла
- ❌ Нет AudioManager / AudioStreamPlayer
- ❌ Нет аудио-шин в project.godot
- ❌ Нет кода воспроизведения

---

## План реализации → Sprint S005

Запланировано на Sprint S005 (после завершения S004).
