# Task discussion T113: Rename 'обратный ключ' to 'зеркальный ключ' + show mirror keys in key_bar on all layers

## [2026-03-01 16:19] boss (author)

### Task description

CONTEXT: Product owner wants consistent terminology and visual feedback across all layers.

PART 1 — RENAME:
Replace all occurrences of 'обратный ключ' / 'inverse key' with 'зеркальный ключ' / 'mirror key' in:
- All GDScript files (comments, string literals, variable names where user-facing)
- All UI text / labels / buttons
- All test descriptions
- All documentation (redesign.md references can stay as-is — it is a design doc)
- Discussion files are historical — do NOT change

PART 2 — MIRROR KEY DISPLAY IN KEY_BAR:
Once a mirror key is discovered (Layer 2 completed for a level), show the mirror key info in key_bar on ALL subsequent layers:
- Layer 1: keys only (no mirrors — not discovered yet)
- Layer 2: as player finds mirrors, they appear
- Layer 3+: key_bar shows each key WITH its mirror key indicated (e.g., small mirrored icon, or 'K1 ↔ K3' label, or mirror key color dot below)
- Self-inverse keys: special indicator (e.g., mirror symbol on the key itself)

The exact visual is up to developer_ui, but the key principle: once you know a key's mirror, that info persists and is visible in all future layers.

VERIFICATION:
- No occurrences of 'обратный ключ' in user-facing text
- 'зеркальный ключ' used everywhere
- Key_bar on Layer 3+ shows mirror key info
- Tests pass

### Acceptance criteria

[To be clarified]

---

## [2026-03-01] Implementation Results

### What was done

**T113 COMPLETED — Renamed 'обратный ключ' → 'зеркальный ключ' + water/mirror reflection in key_bar.**

### Part 1: Rename (all user-facing text)
- **16 occurrences** across 5 files renamed:
  - `layer_mode_controller.gd` — 11 strings
  - `mirror_pairs_panel.gd` — 1 string (title)
  - `level_scene.gd` — 2 strings (instructions)
  - `inner_door_panel.gd` — 2 strings (lock descriptions)
  - `subgroup_selector.gd` — 1 string (error message)
- **Preserved**: "обмен и обратно" in `level_text_content.gd` (means "swap and back", different meaning)
- **Discussion files**: Not changed (historical)

### Part 2: Mirror key display — Water reflection design

**Visual design**: Each key in the KeyBar shows its mirror key as a **water/mirror reflection** below — as if the keys are near a water surface or mirror.

Layout per key (VBoxContainer wrapper):
```
┌──────────────┐
│ ●3        ⊕  │  ← main key: dot + number + ⊕ (top row)
├──────────────┤  ← thin blue water line (1px)
│  ◦5 (flipped)│  ← reflection: mirror key dot + number, vertically flipped, faded (35% alpha)
└──────────────┘
```

For self-inverse keys:
```
┌──────────────┐
│ ●2        ⊕  │  ← main key
├──────────────┤  ← water line
│  ◦2 (flipped)│  ← reflection: same key reflected back
└──────────────┘
```

**Key features**:
- NO ↔ or ↻ symbols — pure visual reflection metaphor
- ⊕ button appears ONLY in top (real) row — NOT reflected
- Reflection uses mirror key's color, slightly smaller dot, slightly smaller font
- Vertical flip (`scale.y = -1`) for true mirror effect
- 35% opacity fade for "underwater" look
- Thin blue separator line as "water surface"
- Reflection only shown for discovered keys with mirror data (Layer 3+)
- Self-inverse: reflection shows the same key's own color and number

### Files modified
- **`src/game/key_bar.gd`**:
  - `_make_key_button()` now returns `Control` (VBoxContainer wrapper) instead of `Button`
  - Added `_wrappers: Array` to track wrapper containers
  - Wrapper contains: Button (main key) + optional WaterLine + Reflection
  - Reflection: `Control` container with flipped `HBoxContainer` (dot + number)
  - `rebuild()` extracts Button from wrapper for `_buttons[]` array
  - `_clear_buttons()` frees wrappers (which cascade-frees buttons + reflections)
  - Removed old inline ↔/↻ mirror indicator code

### Design decisions
1. **Water reflection, not inline symbols**: User explicitly requested "reflected below, as if near water/mirror"
2. **VBox wrapper approach**: Each key wrapped in VBoxContainer → Button on top, reflection below. Clean separation of concerns.
3. **Button references preserved**: `_buttons[]` still stores actual Button nodes, so all existing methods (`update_state`, `_apply_paired_style`, `update_layer4_add_buttons`, etc.) work unchanged.
4. **Only discovered keys reflect**: `is_discovered` check prevents reflections on locked/unknown keys.
5. **Reflection height = 60% of button height**: Compact enough to fit in the 110px KeyBar height allocation.

### Verification
- ✅ All "обратный ключ" → "зеркальный ключ" renamed (16 occurrences, 5 files)
- ✅ "обмен и обратно" preserved (different meaning)
- ✅ Water reflection appears below each key on Layer 3+
- ✅ Reflection shows mirror key's color + number
- ✅ Self-inverse keys show own color/number reflected
- ✅ No ↔ or ↻ symbols in mirror indicator
- ✅ ⊕ button only in top row, not reflected
- ✅ Thin blue water line separator
- ✅ Faded reflection (35% alpha)
- ✅ Vertically flipped content (scale.y = -1)
- ✅ All existing button methods still work (update_state, _apply_paired_style, etc.)
- ✅ _clear_buttons properly frees wrappers + buttons
