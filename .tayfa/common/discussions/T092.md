# Task discussion T092: REDESIGN Layer 2: new gameplay — discover inverse pairs by pressing keys

## [2026-02-27 21:08] boss (author)

### Task description

CONTEXT: Current Layer 2 implementation is WRONG. It uses a separate pairing panel where player picks candidates from a list. This must be completely redesigned.

CORRECT CONCEPT (from product owner):
Layer 2 reuses the SAME UI as Layer 1 (room map + key bar + crystal view) with these differences:

1. CRYSTAL DRAGGING DISABLED — player cannot move crystals manually (already correct)
2. NO TARGET PREVIEW — every key application leaves crystals in a valid position
3. ALL KEYS VISIBLE from start — player already found them in Layer 1
4. KEY NAMES unchanged — same number + color as Layer 1 (NO r1, e, sh names)
5. ROOM MAP VISIBLE — same as Layer 1, showing all rooms and transitions
6. GAMEPLAY FLOW:
   a. Player sees all keys in KeyBar
   b. Player presses key A → crystals move, player is now in room X
   c. Player presses key B → crystals move back to Home (room 0)
   d. System detects: player went A then B and returned to Home → A and B are inverse pair!
   e. Keys A and B visually move together (paired) in KeyBar
   f. If player presses key C and returns to Home immediately → C is self-inverse
   g. Self-inverse keys should be visually distinct (paired with themselves)
7. COMPLETION: all keys are paired (each with another key, or self-paired)

WHAT TO DELETE/REPLACE:
- DELETE inverse_pairing_panel.gd (the separate pairing UI)
- REWRITE layer_mode_controller.gd to use existing Level 1 UI
- KEEP inverse_pair_manager.gd core logic (pair detection), but adapt interface

WHAT TO MODIFY:
- level_scene.gd: Layer 2 mode uses same layout as Layer 1, disables crystal drag, hides target
- key_bar.gd: add pairing visualization (paired keys grouped, self-inverse marked)
- room_map_panel.gd: visible in Layer 2 (currently hidden — wrong)
- validation logic: detect when player returns to Home after 2 key presses → pair found

KEY BAR PAIRING VISUALIZATION:
- Unpaired keys: normal display (as in Layer 1)
- Paired keys: visually grouped (side by side, connected by bracket/line, or moved to a 'paired' section)
- Self-inverse keys: special marker (e.g. loop arrow, or highlighted border)
- Progress: X/N pairs found

VERIFICATION:
- Layer 2 looks like Layer 1 (room map visible, crystal view, key bar)
- Player presses keys to move between rooms
- Pressing A then B returning to Home detects pair
- Self-inverse detection works
- All keys must be paired to complete
- Key names are numbers + colors (not r1, e, sh)
- No target preview shown
- Tests pass

### Acceptance criteria

[To be clarified]

---
