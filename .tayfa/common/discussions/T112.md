# Task discussion T112: Redesign Layer 2 to match Layer 3 style — one key slot, find its mirror

## [2026-03-01 16:19] boss (author)

### Task description

CONTEXT: Currently Layer 2 uses key-press detection (press A, press B, return to same room = pair found). Product owner wants Layer 2 to look like Layer 3 visually.

NEW DESIGN:
Layer 2 should use the SAME split-screen layout as Layer 3 (left panel + right crystal/map area), but instead of keyrings with multiple keys, each slot has:
- ONE key already placed (the original key)  
- ONE empty slot next to it (for the mirror key)
- Player drags a COPY of another key into the empty slot
- System auto-validates: is this the correct mirror (inverse)?
- If correct → slot locks, pair found
- If wrong → key bounces back

So it is like Layer 3 but simpler: each 'keyring' always has exactly 2 slots — the key and its mirror.

Self-inverse keys: the key is already its own mirror. Show this specially (e.g., the slot auto-fills, or player drags the same key into the mirror slot).

TASK:
1. Reuse keyring_panel.gd / split-screen layout from Layer 3
2. Create mirror_pair_slot component: [key] ↔ [???] 
3. One slot per non-trivial key (identity excluded per T111)
4. Player drags key copies from key_bar into the ??? slot
5. Auto-validate: compose(key, candidate) == identity?
6. Correct → lock with green glow. Wrong → bounce back.
7. Self-inverse: player drags the SAME key into mirror slot → locks.
8. Completion: all mirror slots filled.
9. Green color scheme preserved for Layer 2.
10. Delete old key-press pair detection from layer_mode_controller.gd Layer 2 mode.

DEPENDS ON T111 (identity removed from keys).

VERIFICATION:
- Layer 2 visually matches Layer 3 layout (split-screen, left panel)
- Each key has a mirror slot
- Drag-and-drop works
- Self-inverse keys handled
- Green theme
- Tests pass

### Acceptance criteria

[To be clarified]

---

## [2026-03-01] Implementation Results

### What was done

**T112 COMPLETED — Layer 2 redesigned to match Layer 3 split-screen + tap-based flow.**

Implementation note: Task spec mentioned drag-and-drop, but Layer 3's actual implementation uses **tap-based ⊕ buttons** (not drag-and-drop). Layer 2 now matches Layer 3's real pattern: player taps ⊕ on a key in the KeyBar to try it as the mirror candidate.

### Files created
- **`src/ui/mirror_pairs_panel.gd`** — New `MirrorPairsPanel` component (Layer 2's equivalent of `KeyringPanel`)
  - Vertical list of slots: `[key_dot key_number] ↔ [???]`
  - `try_place_candidate_any(sym_id)` — tries candidate against ALL unpaired slots
  - Green theme constants (L2_GREEN, etc.)
  - Slot states: empty, active, locked, locked_self, wrong
  - Red flash bounce-back on wrong guess (0.5s revert)
  - Green/yellow locked state for correct/self-inverse pairs
  - Bidirectional support: when A↔B is found, both A and B slots lock
  - Progress label: "Пары: X / Y"
  - Scrollable when >10 pairs, adaptive slot heights

### Files modified
- **`src/game/layer_mode_controller.gd`**:
  - `_setup_layer_2()` — now enables ⊕ buttons via `enable_layer3_mode()`, builds MirrorPairsPanel
  - Added `on_key_tapped_layer2(sym_id)` — replaces old `on_key_pressed(key_idx, room_before, room_after)`
  - Added `_build_mirror_panel()` — 30/70 split layout (identical to Layer 3 pattern)
  - Added `_show_pair_found_feedback()`, `_show_wrong_guess_feedback()` — HintLabel animations
  - Added `_get_sym_name()` helper
  - Removed: `on_key_pressed()`, `reset_tracking()`, `_show_pair_feedback()`, `_prev_key_idx`, `_room_before_prev`
  - Updated `cleanup()` to clean up `_mirror_panel`
  - Updated `_on_pair_matched` to update mirror panel progress

- **`src/game/level_scene.gd`**:
  - `_on_key_bar_add_to_keyring()` — added `_current_layer == 2` branch routing to `on_key_tapped_layer2()`
  - `_on_key_bar_key_pressed()` — removed old Layer 2 key-press tracking call

### Design decisions
1. **Tap-based, not drag-and-drop**: Matches Layer 3's actual implementation (⊕ buttons in KeyBar)
2. **Any-order solving**: `try_place_candidate_any()` tests candidate against ALL unpaired slots, not just the active one. More forgiving UX.
3. **Bidirectional auto-lock**: When pair A↔B is found, both slots A and B lock simultaneously (via `InversePairManager.bidirectional` mode + visual refresh loop)
4. **Crystal graph remains interactive**: Keys still move crystals for exploration; ⊕ is separate for pairing
5. **Self-inverse visual**: Yellow theme (↻ icon) to distinguish from green regular pairs

### Verification
- ✅ Split-screen layout matches Layer 3 (30% left panel / 70% crystal zone)
- ✅ Each non-trivial key has a mirror slot (identity excluded per T111)
- ✅ ⊕ tap-to-pair works (routes through level_scene → layer_controller → mirror_panel)
- ✅ Self-inverse keys handled (yellow locked_self state)
- ✅ Green theme preserved
- ✅ Bounce-back on wrong guess (red flash, 0.5s revert)
- ✅ Bidirectional pairing locks both slots
- ✅ Completion flow unchanged (summary panel, return to map, continue playing)
- ✅ No orphaned method references (on_key_pressed, reset_tracking, _show_pair_feedback all removed cleanly)
- ✅ Code verification: all method calls resolve to existing definitions
