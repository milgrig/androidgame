# Task discussion T047: Реализовать движок подгрупп в KeyRing и Permutation

## [2026-02-27 08:30] boss (author)

### Task description

Расширить математическое ядро игры для поддержки подгрупп — ключевая механика Акта 2.

НОВЫЙ ФУНКЦИОНАЛ:

1. **Расширение permutation.gd**:
   - compose_list(perms: Array[Permutation]) -> Permutation: композиция списка
   - is_in_group(perm: Permutation, group: Array[Permutation]) -> bool: принадлежность
   - Статический метод: generate_subgroup_from(generators: Array[Permutation], n: int) -> Array[Permutation]: генерирует подгруппу из генераторов

2. **Расширение key_ring.gd**:
   - check_subgroup(key_indices: Array[int]) -> Dictionary:
     Принимает индексы ключей, проверяет замкнутость подмножества:
     - Содержит identity?
     - Для каждой пары: compose(a,b) в подмножестве?
     - Для каждого элемента: inverse в подмножестве?
     Возвращает: {is_subgroup: bool, missing_elements: Array, reasons: Array[String]}
   
   - get_subgroup_closure(key_indices: Array[int]) -> Array[int]:
     Генерирует замыкание подмножества (добавляет недостающие элементы)
   
   - find_all_subgroups() -> Array[Dictionary]:
     Перебирает все подмножества и находит подгруппы.
     Для малых групп (≤24) — полный перебор.
     Возвращает: [{indices: Array[int], order: int, elements: Array[Permutation]}]

3. **Новый класс: src/core/subgroup_checker.gd**:
   - SubgroupChecker — утилита для работы с подгруппами
   - is_normal(subgroup: Array[Permutation], group: Array[Permutation]) -> bool:
     Проверяет: ∀g∈G, ∀h∈H: g·h·g⁻¹ ∈ H
   - coset_decomposition(subgroup, group) -> Array[Array[Permutation]]:
     Разложение группы на смежные классы по подгруппе
   - lattice(group: Array[Permutation]) -> Dictionary:
     Строит решётку подгрупп (кто кого содержит)

4. **Юнит-тесты** (tests/fast/unit/test_subgroups.py):
   - test_check_subgroup_z3_in_s3: Z3 — подгруппа S3
   - test_check_subgroup_z2_in_s3: Z2 — подгруппа S3 
   - test_not_subgroup: произвольное подмножество — не подгруппа
   - test_closure: замыкание подмножества
   - test_find_all_subgroups_s3: все подгруппы S3 (e, Z2×3, Z3, S3)
   - test_is_normal_z3_in_s3: Z3 нормальна в S3 (да)
   - test_is_normal_z2_in_s3: Z2 нормальна в S3 (нет)
   - test_cosets: смежные классы

MUST прочитать:
- src/core/permutation.gd (текущий API)
- src/core/key_ring.gd (текущий API)
- src/core/graph_engine.gd (как вычисляются автоморфизмы)

### Acceptance criteria

[To be clarified]

---
