# Task discussion T100: UX: Post-completion mode — stay and play + menu button

## [2026-02-27 22:51] boss (author)

### Task description

CONTEXT: After completing a level, player currently can only exit to map. Product owner wants two changes:

REQUIREMENT 1 — STAY AND PLAY:
After level completion (all keys found / all pairs matched / all keyrings filled):
- Show completion banner/summary as now
- But DO NOT force exit to map
- Player can dismiss the banner and CONTINUE playing with the level freely
- A persistent button 'Победа! Выход на карту' (or similar) stays visible so player can exit anytime
- This applies to ALL layers (1, 2, 3+)

REQUIREMENT 2 — MENU BUTTON:
- Add a menu/hamburger button always visible during gameplay (top-left or top-right corner)
- Menu options:
  * 'Выход на карту' — return to map (works even mid-level, for hard levels)
  * 'Настройки' — settings (sound, etc. — placeholder for now)
- Menu should be a small overlay/popup, not a full screen

TASK:
1. In level_scene.gd: after completion, dismiss summary but keep playing
2. Add persistent 'exit to map' button after completion
3. Add menu button (hamburger icon) to HUD
4. Create simple menu popup with 'Карта' and 'Настройки' options
5. Settings screen can be minimal (placeholder)

VERIFICATION:
- After completing level, player can continue interacting
- Exit button visible after completion
- Menu button always accessible
- Menu -> Карта returns to map
- Works on all layers

### Acceptance criteria

[To be clarified]

---

## Implementation

### Files Modified

1. **`src/game/hud_builder.gd`**
   - Added `build_menu_button()` — hamburger menu button (☰) + popup with "Карта" and "Настройки"
   - Added `_toggle_menu_popup()`, `hide_menu_popup()` — toggle/hide popup
   - Added `show_post_completion_exit_button()`, `hide_post_completion_exit_button()` — persistent "Выход на карту" button after completion
   - Added `dismiss_complete_summary()` — fade-out dismissal of completion panel
   - Modified `_build_complete_summary_panel()` — added "Продолжить играть" dismiss button
   - Modified `show_complete_summary()` — shows dismiss button
   - Modified `build_split_hud()` — integrates menu button via on_map/on_settings callbacks

2. **`src/game/level_scene.gd`**
   - Added `_level_completed_flag` — prevents re-triggering completion
   - Modified `_setup_scene_structure()` — passes on_map/on_settings callbacks to build_split_hud
   - Modified `_on_level_complete()` — sets flag, no longer permanently disables crystals
   - Modified `_show_complete_summary()` — connects dismiss button
   - Added `_on_summary_dismissed()` — dismisses summary, re-enables crystals (Layer 1), shows persistent exit button
   - Added `_on_menu_map_pressed()` — returns to map via menu
   - Added `_on_menu_settings_pressed()` — opens settings popup
   - Added `_show_settings_popup()` — placeholder settings panel
   - Added `_hide_settings_popup()` — closes settings
   - Modified `_input()` — closes menu popup on click outside
   - Modified `_clear_level()` — cleans up T100 UI elements
   - Modified `_build_level()` — resets _level_completed_flag
   - Modified `_on_layer_completed()` — sets _level_completed_flag

3. **`src/game/layer_mode_controller.gd`**
   - Modified `_show_layer_2_summary()` — added "Продолжить играть" dismiss button
   - Added `_on_dismiss_layer_2_summary()` — dismisses L2 summary + shows persistent exit button

### Verification Checklist
- [x] After completing level, player can dismiss summary and continue interacting
- [x] Crystals re-enabled after dismiss on Layer 1
- [x] Layer 2 allows continued key-press exploration after dismiss
- [x] Persistent "Выход на карту" exit button visible after completion
- [x] Menu button (☰) always visible in top-right corner
- [x] Menu popup with "Карта" and "Настройки" options
- [x] Menu → Карта returns to map
- [x] Menu → Настройки opens placeholder settings popup
- [x] Menu popup closes on click outside
- [x] Works on all layers (1, 2, 3+)

Status: **DONE**
