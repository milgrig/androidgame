# Task discussion T046: Архитектор: архитектура механики подгрупп и внутренних дверей (Акт 2)

## [2026-02-27 08:29] boss (author)

### Task description

Разработать архитектурный план для новых механик Акта 2: подгруппы (внутренние двери) и факторизация (склейка).

КОНТЕКСТ (из Game.txt):
Акт 2 (уровни 13-24) вводит три новые механики:
1. Уровни 13-16: ВНУТРЕННИЕ ДВЕРИ (подгруппы) — подмножество ключей, замкнутое относительно композиции
2. Уровни 17-20: СКЛЕЙКА УЗЛОВ (нормальные подгруппы) — объединение узлов связанных внутренним ключом
3. Уровни 21-24: ФАКТОРИЗАЦИЯ (башня подгрупп) — цепочка упрощений

ЗАДАЧИ ДЛЯ ЭТОГО СПРИНТА (только уровни 13-16):

1. **Расширение формата level JSON**:
   - Новое поле subgroups: [{name, order, elements, is_normal, is_inner_door}]
   - Новое поле inner_doors: [{subgroup_name, visual_hint, unlock_condition}]
   - Обратная совместимость: уровни Акта 1 без этих полей работают как раньше

2. **Расширение LevelScene**:
   - Новый UI элемент: панель 'Внутренние двери' (список дверей, каждая = подгруппа)
   - Механика: игрок выбирает подмножество найденных ключей → кнопка 'ОТКРЫТЬ ДВЕРЬ'
   - Валидация: проверка что выбранное подмножество замкнуто (является подгруппой)
   - Визуальный feedback: дверь открывается / трещит если не подгруппа

3. **Расширение KeyRing**:
   - Метод check_subgroup(key_indices: Array[int]) -> bool: проверяет замкнутость
   - Метод get_subgroup_elements(key_indices) -> Array[Permutation]: все элементы подгруппы
   - Метод generate_subgroup(key_indices) -> Array[Permutation]: генерация подгруппы из подмножества

4. **UI для подгрупп**:
   - Визуализация 'внутренней двери' в зале (декоративный элемент на графе)
   - Режим выбора ключей для двери (чекбоксы или drag-to-door)
   - Анимация открытия двери при правильной подгруппе
   - Анимация 'трещины' при неправильной попытке

5. **Интеграция с HallTree**:
   - Новый тип прогресса: hall + inner_doors (все двери открыты)
   - PERFECT seal = все ключи + все двери + без подсказок уровня 3

6. **Расширение Agent Bridge**:
   - Новая команда: check_subgroup(key_indices) → {is_subgroup: bool, missing: [...]}
   - Новая команда: open_inner_door(subgroup_name) → {success: bool, message: ...}
   - get_state() возвращает inner_doors status

DELIVERABLES:
- Архитектурный документ с диаграммами, API контрактами, структурами данных
- Оценка трудозатрат (story points)
- Приоритизация: что делать в S005, что отложить
- Совместимость с текущим кодом (minimal changes to existing files)

MUST прочитать:
- Game.txt (Акт 2)
- redesign.md (пункт 5 — невозможные залы, связано с нормальностью)
- .tayfa/architect/ARCH_T024_HALL_TREE.md (текущая архитектура)
- src/game/level_scene.gd (текущая логика уровня)
- src/core/key_ring.gd (текущий API кольца ключей)

### Acceptance criteria

[To be clarified]

---
