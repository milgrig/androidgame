# Task discussion T044: БАГФИКС: Кнопка ПОВТОРИТЬ — кристаллы не двигаются визуально

## [2026-02-27 08:28] boss (author)

### Task description

Баг: при нажатии кнопки ПОВТОРИТЬ кристаллы не анимируются — они должны перемещаться так же красиво, как когда игрок делает свопы руками. Игрок должен ВИДЕТЬ, как каждый кристалл летит на новую позицию, чтобы понять, что происходит.

ТЕКУЩЕЕ ПОВЕДЕНИЕ:
- Кнопка ПОВТОРИТЬ нажимается
- Кристаллы мгновенно оказываются на новых позициях (телепорт) или вообще не двигаются
- Игрок не понимает, что произошло

ОЖИДАЕМОЕ ПОВЕДЕНИЕ:
- Кристаллы плавно перемещаются по дуговым траекториям (Bezier arc)
- Видно, КУДА каждый кристалл летит (как карусель для циклов)
- 3 фазы: подъём (scale up) → полёт по дугам → приземление (bounce)
- Общее время ~0.9 сек
- После анимации: валидация + feedback (valid/invalid)

АНАЛИЗ КОДА:
1. _apply_repeat_key() (строка 1834): вычисляет new_arrangement правильно
2. Phase 1 (строка 1900): Tween scale 1.0→1.08 — РАБОТАЕТ
3. Phase 2 (строка 1933): _repeat_phase2 вызывает _animate_crystal_arc_tween()
4. _animate_crystal_arc_tween() (строка 1915): двигает crystal.position через Tween
5. ПРОБЛЕМА: crystal.get_home_position() (строка 1950) возвращает _original_position, 
   но после перемешивания и предыдущих repeat кристалл может быть уже НЕ на home position.
   from_pos может не совпадать с crystal.position → анимация начинается из невидимой точки
6. ДОПОЛНИТЕЛЬНО: кристаллы могут не обновлять home_position после repeat анимации корректно

ЗАДАЧИ:
1. Заменить crystal.get_home_position() на crystal.position в _repeat_phase2 (строка 1950)
2. Или лучше: перейти на crystal.animate_to_position() как в _perform_swap() (строка 911)
3. Убедиться что home_position обновляется в _repeat_phase3 (строка 1984)
4. Проверить что _repeat_animating блокирует повторные клики во время анимации
5. Протестировать через Agent Bridge:
   - level_01 (Z3): repeat r1 → визуально видно вращение треугольника
   - level_05 (D4): repeat r1 4 раза → виден полный цикл вращений
   - level_11 (Z6): repeat r1 5 раз → полная карусель
6. Сравнить визуально с _perform_swap() — движение должно быть таким же понятным

КРИТЕРИИ ПРИЁМКИ:
- [ ] Кристаллы визуально перемещаются при нажатии ПОВТОРИТЬ
- [ ] Анимация плавная, по дугам (не телепорт)
- [ ] Работает для identity (flash, без движения) и для всех остальных ключей
- [ ] Работает на всех 12 уровнях
- [ ] Повторное нажатие ПОВТОРИТЬ после анимации работает корректно (цепочка)

MUST прочитать:
- src/game/level_scene.gd строки 1834-2009 (_apply_repeat_key и все фазы)
- src/visual/crystal_node.gd (animate_to_position, get_home_position, set_home_position)

### Acceptance criteria

[To be clarified]

---
