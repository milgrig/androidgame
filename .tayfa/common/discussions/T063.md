# Task discussion T063: БАГФИКС P0: Имена ключей не соответствуют перестановкам (rebasing inconsistency)

## [2026-02-27 13:19] boss (author)

### Task description

КОНТЕКСТ: На Level 13 (S3) игрок выбирает 'Тождество' — а игра говорит что надо добавить 'тождество', которое оказывается 'Обмен A и C'. Причина: rebasing logic непоследовательный.

КОРЕНЬ ПРОБЛЕМЫ:
Есть 5 мест в level_scene.gd которые ищут имя перестановки по target_perms:
1. _get_key_display_name() (строка ~1465) — ПРАВИЛЬНО, делает rebase
2. _validate_permutation() (строка ~1211) — ПРАВИЛЬНО, делает rebase
3. _build_summary_keys_text() (строка ~1738) — БАГ, НЕ делает rebase
4. _on_combine_key_selected() (строка ~1400) — БАГ, НЕ делает rebase
5. _update_status_label() (строка ~1528) — БАГ, НЕ делает rebase

Из-за этого: после rebasing первый найденный ключ корректно называется 'Тождество', но когда игрок достигает реального тождественного расположения [0,1,2], оно ребейзится в first_perm^{-1} и показывается как 'Обмен A и C'.

ЗАДАЧА:
1. Создать единый метод _lookup_display_name(perm: Permutation) -> String который ВСЕГДА ребейзит перед поиском в target_perms
2. Заменить все 5 мест поиска имени на вызов этого метода
3. Проверить _on_combine_key_selected — result_perm тоже должен ребейзиться
4. Проверить _build_summary_keys_text — использовать _get_key_display_name(i)
5. Проверить _update_status_label — ребейзить perm перед сравнением

ДОПОЛНИТЕЛЬНО — дизайн-вопрос (обсудить с game_designer):
Нужно ли вообще ребейзить? Может лучше чтобы тождество всегда было [0,1,2], а первый ключ назывался как есть? Пока что — исправить consistency, потом можно пересмотреть.

ВЕРИФИКАЦИЯ:
- Level 13: найти identity [0,1,2] → должно отобразиться как 'Тождество'
- Level 13: найти [2,1,0] → должно отобразиться как 'Обмен A и C'
- Level 13: скомбинировать два ключа → имя результата правильное
- Level 13: summary при завершении → все имена правильные
- Проверить level_01 (Z3) — регрессия не сломана

КРИТЕРИЙ DONE: на Level 13 каждый ключ отображается с правильным именем, независимо от порядка нахождения.

### Acceptance criteria

[To be clarified]

---
