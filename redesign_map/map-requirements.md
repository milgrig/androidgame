# Карта комнат — Требования

## Версия: 0.1
## Дата: 2026-02-27
## Прототип: rooms-keys.html

---

## 1. Общее описание

Карта — визуальное отображение всех найденных комнат и связей между ними. Является вторым основным элементом интерфейса наряду с полем кристаллов. Карта не содержит постоянных рёбер — связи возникают только как следы действий игрока и при выборе ключей.

---

## 2. Соответствие «комната — ключ»

### 2.1. Один к одному
Каждая комната имеет ровно один соответствующий ключ. Количество комнат = количество ключей. Комната №0 (Дом) соответствует тривиальному ключу (тождество).

### 2.2. Ключ — это путь из Дома
Ключ комнаты N — это преобразование кристаллов, которое ведёт из Дома (комната 0) в комнату N. Применение ключа из другой комнаты ведёт не обязательно в комнату N — ключ задаёт действие, а не адрес назначения.

### 2.3. Единая идентификация
Каждая пара «комната — ключ» имеет:
- **Номер** — целое число от 0 до (N-1)
- **Цвет** — уникальный, используется и для узла на карте, и для ключа в панели, и для рёбер при переходах
- Комната 0 (Дом) — золотой цвет (#c9a84c)
- Остальные цвета генерируются с максимальным разбросом по hue

---

## 3. Карта: визуальное представление

### 3.1. Узлы
- Каждая найденная комната — **квадратик** (не круг) цвета этой комнаты
- Ненайденные комнаты — слабый пунктирный контур без заливки
- Текущая комната — подсвечена ярче, с эффектом свечения (glow)
- При наведении — узел подсвечивается, показывается номер и имя комнаты

### 3.2. Размеры узлов
- До 12 комнат — узлы 11px, всегда видны номера
- 13–16 комнат — узлы 9px, номера видны при наведении и для текущей
- Более 16 комнат — узлы 7px, номера видны только при наведении и для текущей

### 3.3. Расположение узлов (layout)
- Концентрические слои по расстоянию от Дома (BFS)
- Дом — в центре
- Слой 1 — комнаты, достижимые одним ключом
- Слой 2 — комнаты в двух шагах, и т.д.
- Внутри слоя — равномерное распределение по дуге
- Force-directed relaxation для устранения наложений

---

## 4. Карта: рёбра (связи)

### 4.1. Основной принцип
**Карта по умолчанию не содержит рёбер.** Рёбра появляются только в двух случаях:
- Как затухающие следы при применении ключа (раздел 4.2)
- Как подсветка при выборе ключа в панели (раздел 4.3)

### 4.2. Затухающие следы (fading edges)
При каждом применении ключа (переход из комнаты A в комнату B):
- На карте рисуется **дуга** от узла A к узлу B
- Цвет дуги = цвет применённого ключа
- Дуга имеет **стрелку** на конце (направление перехода)
- Дуга плавно затухает (alpha уменьшается с коэффициентом ~0.985 за кадр)
- Несколько последовательных переходов оставляют несколько следов разных цветов — «маршрут» игрока
- Дуга слегка изогнута (quadratic bezier), чтобы дуга A→B и дуга B→A не накладывались

### 4.3. Подсветка при выборе ключа (hover preview)
При наведении курсора на ключ в панели:
- На карте отображаются **все переходы** этого ключа из всех найденных комнат
- Линии тонкие, полупрозрачные (alpha ~0.2), одного цвета (цвет ключа)
- Это показывает «паттерн» ключа — как он действует на всё пространство целиком
- При уходе курсора — линии исчезают мгновенно

### 4.4. Запоминание пройденных путей
- Каждый совершённый переход сохраняется в историю: {из, в, ключ, время}
- При повторном выборе того же ключа в панели, помимо паттерна (4.3), ранее пройденные этим ключом рёбра отображаются чуть ярче (alpha ~0.35)
- Это позволяет видеть, какие переходы уже были совершены

---

## 5. Панель ключей

### 5.1. Расположение
Горизонтальная панель внизу экрана. Занимает всю ширину.

### 5.2. Элемент ключа
- Квадратик цвета ключа + номер
- Ненайденные ключи — затемнённые, некликабельные
- Ключ текущей комнаты — обведён золотой рамкой
- При наведении — на карте отображается паттерн ключа (4.3)
- При клике — применение ключа:
  - Кристаллы анимированно перемещаются
  - На карте рисуется затухающая дуга (4.2)
  - Текущая комната меняется
  - Если попали в неоткрытую комнату — она открывается

### 5.3. Масштабирование
- До 12 ключей — свободное расположение в одну строку с отступами
- 13–24 ключа — компактная сетка, ключи мельче
- Более 24 — прокрутка или сворачивание

---

## 6. Поле кристаллов

### 6.1. Расположение
Левая половина экрана (или центр, если карта свёрнута).

### 6.2. Два состояния

**Разведка** — кристаллы свободны, перетаскиваются руками. Игрок ищет новые расположения. Фон тёмный. Слоты обозначены пунктиром.

**Комната** — кристаллы зафиксированы на позициях. Фон оживает (мягкое свечение). Под кристаллами — бейдж с цветом и именем текущей комнаты.

### 6.3. Переход между состояниями
- Разведка → Комната: игрок расставил кристаллы в валидное расположение. Вспышка. Кристаллы фиксируются.
- Комната → Комната: игрок нажал ключ. Кристаллы анимированно перелетают. Краткая вспышка цвета ключа.
- Комната → Разведка: игрок нажал «Сбросить» или начал перетаскивать кристалл.

---

## 7. Визуальное разделение

### 7.1. Принцип
Кристаллы и карта — два разных визуальных языка, не пересекающихся:

| Элемент | Кристаллы | Карта |
|---------|-----------|-------|
| Форма | Круги | Квадраты |
| Цветность | Яркие, насыщенные | Приглушённые |
| Эффекты | Свечение, glow | Тонкие линии |
| Ощущение | Живое вещество | Архитектурный чертёж |
| Шрифт | Символы (▲ ● ◆) | Моноширинный, номера |

---

## 8. Открытие комнат

### 8.1. Руками (перетаскивание кристаллов)
- Игрок расставляет кристаллы в новое валидное расположение
- Если расположение соответствует ещё не найденной комнате — комната открывается
- На карте появляется новый узел
- В панели ключей появляется новый ключ
- Ребро на карте НЕ рисуется (переход был ручным, не ключом)

### 8.2. Ключом
- Игрок нажимает ключ в панели
- Кристаллы перелетают в новое расположение
- На карте рисуется затухающая дуга
- Если попали в новую комнату — она открывается как в 8.1

---

## 9. Взаимодействие карты и панели ключей

### 9.1. Наведение на ключ → подсветка на карте
Паттерн всех переходов этого ключа (раздел 4.3).

### 9.2. Наведение на узел карты → подсветка ключа
При наведении на комнату на карте — соответствующий ключ в панели подсвечивается.

### 9.3. Клик на узел карты
Переключает «фокус» на эту комнату (обновляет вид кристаллов). Не добавляет ребро — это не переход ключом, а просмотр.

---

## 10. Масштабируемость

### 10.1. Малые группы (3–6 комнат)
Карта просторная, узлы крупные, номера видны всегда. Панель ключей — одна строка.

### 10.2. Средние группы (8–12 комнат)
Карта плотнее, но читаема. Номера при наведении. Панель — одна строка, компактнее.

### 10.3. Большие группы (24 комнаты)
Карта использует force-directed layout. Узлы мелкие. Номера только при наведении. Затухающие рёбра и hover-подсветка критически важны — без них карта нечитаема. Панель ключей — сетка в 2 строки.

### 10.4. Принцип: карта чистая
Для любого размера группы карта без активного взаимодействия показывает только узлы. Никаких постоянных рёбер. Это позволяет масштабироваться до больших групп.

---

## 11. Анимация и тайминги

| Событие | Длительность | Easing |
|---------|-------------|--------|
| Перелёт кристаллов | 500ms | cubic-bezier(0.34, 1.56, 0.64, 1) |
| Вспышка при входе в комнату | 300ms | ease-out |
| Появление нового узла на карте | 400ms | ease-out (fade-in + scale) |
| Затухание ребра на карте | ~5–8 секунд | exponential decay (alpha × 0.985/frame) |
| Hover-подсветка ключа | мгновенно | — |

---

## 12. Нерешённые вопросы

- Имена комнат: генерировать автоматически или давать смысловые для малых групп?
- Нужен ли полноэкранный режим карты для больших групп?
- Как показать петли (ключ, ведущий в ту же комнату)?
- Звуковое сопровождение переходов?
